# trigger_training.yaml
# ä»è´¦å·B (de2025-475823) è§¦å‘è´¦å·A (pelagic-pager-472017-v5) çš„Vertex AI Pipelineè®­ç»ƒ

steps:
  # æäº¤Vertex AI Pipeline Jobåˆ°è´¦å·A
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        
        # ===========================================
        # é…ç½®å‚æ•°
        # ===========================================
        ACCOUNT_A_PROJECT="pelagic-pager-472017-v5"
        REGION="us-central1"
        PIPELINE_ROOT="gs://temp2_de2025_group6"
        PIPELINE_YAML="${PIPELINE_ROOT}/heart_disease_training_pipeline.yaml"
        
        # Pipelineå‚æ•°
        DATA_BUCKET="data2_de2025_group6"
        MODEL_BUCKET="models2_de2025_group6"
        TRAINSET_FILE="Heart_disease_cleveland_new.csv"
        
        # ===========================================
        # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        # ===========================================
        echo "=========================================="
        echo "ğŸš€ è§¦å‘è´¦å·Açš„Vertex AI Pipelineè®­ç»ƒ"
        echo "=========================================="
        echo "ç›®æ ‡é¡¹ç›®: $ACCOUNT_A_PROJECT"
        echo "Region: $REGION"
        echo "Pipeline Root: $PIPELINE_ROOT"
        echo "Pipeline YAML: $PIPELINE_YAML"
        echo "æ•°æ®bucket: $DATA_BUCKET"
        echo "æ¨¡å‹bucket: $MODEL_BUCKET"
        echo "=========================================="
        
        # ===========================================
        # å®‰è£…Pythonä¾èµ–
        # ===========================================
        echo "ğŸ“¦ å®‰è£…å¿…è¦çš„PythonåŒ…..."
        pip3 install --quiet google-cloud-aiplatform kfp
        
        # ===========================================
        # ä½¿ç”¨Pythonæäº¤Pipeline
        # ===========================================
        echo "ğŸ“¤ æ­£åœ¨æäº¤Pipeline Job..."
        
        python3 << 'EOF'
import google.cloud.aiplatform as aip
from datetime import datetime

# åˆå§‹åŒ–Vertex AI
aip.init(
    project="pelagic-pager-472017-v5",
    location="us-central1",
)

# ç”Ÿæˆå”¯ä¸€çš„jobåç§°
job_name = f"heart-disease-training-{datetime.now().strftime('%Y%m%d-%H%M%S')}"

# åˆ›å»ºPipeline Job
job = aip.PipelineJob(
    display_name=job_name,
    template_path="gs://temp2_de2025_group6/heart_disease_training_pipeline.yaml",
    pipeline_root="gs://temp2_de2025_group6",
    parameter_values={
        'project_id': 'pelagic-pager-472017-v5',
        'data_bucket': 'data2_de2025_group6',
        'trainset_filename': 'Heart_disease_cleveland_new.csv',
        'model_repo': 'models2_de2025_group6'
    },
    enable_caching=False,
)

# æäº¤job (å¼‚æ­¥)
job.submit()

print(f"âœ… Pipeline Jobå·²æäº¤!")
print(f"Jobåç§°: {job_name}")
print(f"Jobèµ„æº: {job.resource_name}")
print(f"æŸ¥çœ‹è¿›åº¦: https://console.cloud.google.com/vertex-ai/pipelines?project=pelagic-pager-472017-v5")
EOF
        
        echo ""
        echo "=========================================="
        echo "âœ… è§¦å‘æˆåŠŸ!"
        echo "=========================================="

timeout: 1200s  # 20åˆ†é’Ÿè¶…æ—¶

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'