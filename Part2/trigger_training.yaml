# trigger_training.yaml
# ä»è´¦å·B (de2025-475823) è§¦å‘è´¦å·A (pelagic-pager-472017-v5) çš„Vertex AI Pipelineè®­ç»ƒ

steps:
# æäº¤ Vertex AI Pipeline Job
- name: gcr.io/google.com/cloudsdktool/cloud-sdk:latest
  entrypoint: "bash"
  args:
    - -c
    - |
      set -euo pipefail

      # ================================
      # é…ç½®å‚æ•°ï¼ˆæŒ‰ä½ å®é™…æƒ…å†µæ”¹ï¼‰
      # ================================
      ACCOUNT_A_PROJECT="pelagic-pager-472017-v5"
      REGION="us-central1"

      PIPELINE_ROOT="gs://temp2_de2025_group6"
      # æ³¨æ„ï¼šè¿™é‡Œè¦å†™ä½ ç¼–è¯‘å‡ºæ¥çš„ pipeline æ¨¡æ¿çš„**å®é™…æ–‡ä»¶å**ï¼ˆ.json æˆ– .yamlï¼‰
      PIPELINE_YAML="${PIPELINE_ROOT}/heart_disease_training_pipeline.yaml"

      DATA_BUCKET="data2_de2025_group6"
      MODEL_BUCKET="models2_de2025_group6"
      TRAINSET_FILE="Heart_disease_cleveland_new.csv"

      echo "================ Pipeline Config ================"
      echo "Project:        ${ACCOUNT_A_PROJECT}"
      echo "Region:         ${REGION}"
      echo "Pipeline Root:  ${PIPELINE_ROOT}"
      echo "Pipeline YAML:  ${PIPELINE_YAML}"
      echo "Data Bucket:    ${DATA_BUCKET}"
      echo "Model Bucket:   ${MODEL_BUCKET}"
      echo "================================================="

      # ä¾èµ–
      pip3 install --quiet google-cloud-aiplatform kfp

      echo "ğŸš€ æ­£åœ¨æäº¤ Pipeline Job..."

      # --- å…³é”®ï¼šheredoc å¿…é¡»åœ¨å¤šè¡Œå­—ç¬¦ä¸²ä¸­ï¼Œä¸”ç»“æŸæ ‡è®°ä¸æ­¤è¡Œå¯¹é½ ---
      python3 <<'PYCODE'
from google.cloud import aiplatform as aip
from datetime import datetime

PROJECT = "pelagic-pager-472017-v5"
LOCATION = "us-central1"

PIPELINE_YAML = "gs://temp2_de2025_group6/heart_disease_training_pipeline.yaml"
PIPELINE_ROOT = "gs://temp2_de2025_group6"

PARAMS = {
    "project_id": PROJECT,
    "data_bucket": "data2_de2025_group6",
    "trainset_filename": "Heart_disease_cleveland_new.csv",
    "model_repo": "models2_de2025_group6",
}

aip.init(project=PROJECT, location=LOCATION, staging_bucket=PIPELINE_ROOT)

job_name = f"heart-disease-training-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
job = aip.PipelineJob(
    display_name=job_name,
    template_path=PIPELINE_YAML,
    pipeline_root=PIPELINE_ROOT,
    parameter_values=PARAMS,
    enable_caching=False,
)
job.submit()

print("âœ… Pipeline Job å·²æäº¤")
print("Job åç§°:", job_name)
print("èµ„æºå:", job.resource_name)
PYCODE
      # --- heredoc ç»“æŸæ ‡è®°è¡Œï¼ˆPYCODEï¼‰å‰é¢ä¸è¦æœ‰å¤šä½™ç©ºæ ¼ ---

      echo "================================"
      echo "âœ… è§¦å‘æˆåŠŸï¼"
      echo "================================"

timeout: "1200s"  # 20åˆ†é’Ÿ
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8
