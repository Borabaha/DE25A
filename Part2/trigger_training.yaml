# trigger_training.yaml
# æäº¤ Vertex AI Pipeline ä»»åŠ¡

steps:
# Step 1: æ‰“å°é…ç½®ä¿¡æ¯
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ Vertex AI Pipeline è§¦å‘å¼€å§‹"
      echo "======================================"
      echo "Project: pelagic-pager-472017-v5"
      echo "Region: us-central1"
      echo "Pipeline Root: gs://temp2_de2025_group6"
      echo "Pipeline YAML: gs://temp2_de2025_group6/heart_disease_training_pipeline.yaml"
      echo "Data Bucket: data2_de2025_group6"
      echo "Model Bucket: models2_de2025_group6"
      echo "======================================"

# Step 2: å®‰è£… Python ä¾èµ–
- name: 'python:3.10'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      pip install --quiet google-cloud-aiplatform kfp

# Step 3: æäº¤ Vertex AI Pipeline ä»»åŠ¡
- name: 'python:3.10'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ æ­£åœ¨æäº¤ Vertex AI Pipeline Job..."

      python3 - <<'PYCODE'
      from google.cloud import aiplatform as aip
      from datetime import datetime

      PROJECT = "pelagic-pager-472017-v5"
      LOCATION = "us-central1"
      PIPELINE_YAML = "gs://temp2_de2025_group6/heart_disease_training_pipeline.yaml"
      PIPELINE_ROOT = "gs://temp2_de2025_group6"

      PARAMS = {
          "project_id": PROJECT,
          "data_bucket": "data2_de2025_group6",
          "trainset_filename": "Heart_disease_cleveland_new.csv",
          "model_repo": "models2_de2025_group6",
      }

      aip.init(project=PROJECT, location=LOCATION, staging_bucket=PIPELINE_ROOT)
      job_name = f"heart-disease-training-{datetime.now().strftime('%Y%m%d-%H%M%S')}"

      job = aip.PipelineJob(
          display_name=job_name,
          template_path=PIPELINE_YAML,
          pipeline_root=PIPELINE_ROOT,
          parameter_values=PARAMS,
          enable_caching=False,
      )
      job.submit()

      print("âœ… Pipeline Job å·²æäº¤")
      print(f"Job åç§°: {job_name}")
      print(f"èµ„æºå: {job.resource_name}")
      PYCODE

# Step 4: æ‰“å°æˆåŠŸæ—¥å¿—
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "======================================"
      echo "âœ… Vertex AI Pipeline è§¦å‘æˆåŠŸï¼"
      echo "======================================"

timeout: "1200s"  # 20åˆ†é’Ÿè¶…æ—¶

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8
